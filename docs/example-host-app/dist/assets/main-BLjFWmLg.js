var g=Object.defineProperty;var m=(o,e,t)=>e in o?g(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var a=(o,e,t)=>m(o,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();class h{constructor(e){a(this,"dataProvider");a(this,"currentPlugin",null);a(this,"eventListeners",new Map);this.dataProvider=e,this.setupMessageListener()}async loadPlugin(e){this.currentPlugin&&await this.unloadPlugin();const t=this.generateIframeUid();try{const n=this.createIframe(e,t);this.currentPlugin={iframeUid:t,iframe:n,config:e},this.insertIframeIntoDOM(n,e);const i=this.buildPluginUrl(e.url,t);return n.src=i,this.emit("plugin-loaded",{iframeUid:t,url:e.url}),t}catch(n){const i=n instanceof Error?n.message:"Unknown error";throw this.emit("plugin-error",{error:i}),n}}async unloadPlugin(){if(!this.currentPlugin)return;this.currentPlugin.iframe.parentNode&&this.currentPlugin.iframe.parentNode.removeChild(this.currentPlugin.iframe);const e=this.currentPlugin.iframeUid;this.currentPlugin=null,this.emit("plugin-unloaded",{iframeUid:e})}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}off(e,t){const n=this.eventListeners.get(e);if(n){const i=n.indexOf(t);i>-1&&n.splice(i,1)}}emit(e,t){const n=this.eventListeners.get(e);n&&n.forEach(i=>{try{i(t)}catch(r){console.error(`Error in event listener for ${e}:`,r)}})}createIframe(e,t){const n=document.createElement("iframe");n.id=`plugin-iframe-${t}`,n.style.width=e.width||"100%",n.style.height=e.height||"600px",n.style.border="none";const i=["allow-scripts","allow-same-origin","allow-forms","allow-popups","allow-popups-to-escape-sandbox"],r=e.permissions||i;return n.sandbox.add(...r),n.loading="lazy",n.allow="fullscreen",n}insertIframeIntoDOM(e,t){const n=document.getElementById("plugin-iframe");if(!n)throw new Error("Plugin iframe container not found");n.replaceWith(e),e.id="plugin-iframe"}buildPluginUrl(e,t){const n=new URL(e);return n.searchParams.set("iframeUid",t),n.toString()}generateIframeUid(){return`iframe_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}setupMessageListener(){window.addEventListener("message",e=>{this.handlePluginMessage(e)})}async handlePluginMessage(e){if(!e.data||typeof e.data!="object")return;const t=e.data;if(!t.type||!t.iframeUid||!t.requestId){const n=e.data;if(n.target||n.source||n.action||n.command)return;console.warn("[PluginHost] Invalid message structure:",t);return}if(!this.currentPlugin||t.iframeUid!==this.currentPlugin.iframeUid){console.warn("[PluginHost] Message from unknown plugin:",t.iframeUid);return}if(this.currentPlugin.config.allowedOrigins&&!this.currentPlugin.config.allowedOrigins.includes("*")&&!this.currentPlugin.config.allowedOrigins.includes(e.origin)){console.warn("[PluginHost] Message from unauthorized origin:",e.origin);return}switch(this.emit("plugin-communication",{type:t.type,method:t.method,origin:e.origin}),t.type){case"api_request":await this.handleApiRequest(t,e.source);break;case"init":await this.handlePluginInit(t,e.source);break;default:console.warn("[PluginHost] Unknown message type:",t.type)}}async handleApiRequest(e,t){try{this.emit("api-request",{method:e.method,params:e.params,iframeUid:e.iframeUid});let n;switch(e.method){case"getUserInfo":n=await this.dataProvider.getUserInfo();break;case"getCommunityInfo":n=await this.dataProvider.getCommunityInfo();break;case"getUserFriends":const{limit:i,offset:r}=e.params||{};n=await this.dataProvider.getUserFriends(i||10,r||0);break;case"giveRole":const{roleId:s,userId:c}=e.params||{};n=await this.dataProvider.giveRole(s,c);break;default:throw new Error(`Unknown API method: ${e.method}`)}this.sendResponse(t,e,n)}catch(n){const i=n instanceof Error?n.message:"Unknown error";this.sendError(t,e,i)}}async handlePluginInit(e,t){this.emit("plugin-initialized",{iframeUid:e.iframeUid})}sendResponse(e,t,n){const i={type:"api_response",iframeUid:t.iframeUid,requestId:t.requestId,data:n};e.postMessage(i,"*")}sendError(e,t,n){const i={type:"api_response",iframeUid:t.iframeUid,requestId:t.requestId,error:n};e.postMessage(i,"*")}}const l={id:"user_12345",name:"Alice Johnson",email:"alice@example.com",roles:["member","contributor"],twitter:{username:"alice_codes"},lukso:{username:"alice.lukso"},farcaster:{username:"alice-fc"}},u={id:"community_67890",title:"Web3 Developers Community",description:"A thriving community of Web3 developers building the future",roles:[{id:"member",title:"Member",description:"Basic community member",assignmentRules:{type:"free",requirements:null}},{id:"contributor",title:"Contributor",description:"Active community contributor",assignmentRules:{type:"free",requirements:null}},{id:"moderator",title:"Moderator",description:"Community moderator with special permissions",assignmentRules:{type:"restricted",requirements:{minContributions:10}}},{id:"admin",title:"Administrator",description:"Community administrator",assignmentRules:null}]},d=[{id:"user_11111",name:"Bob Smith",imageUrl:"https://api.dicebear.com/7.x/avataaars/svg?seed=Bob"},{id:"user_22222",name:"Carol Wilson",imageUrl:"https://api.dicebear.com/7.x/avataaars/svg?seed=Carol"},{id:"user_33333",name:"David Chen",imageUrl:"https://api.dicebear.com/7.x/avataaars/svg?seed=David"},{id:"user_44444",name:"Emma Davis",imageUrl:"https://api.dicebear.com/7.x/avataaars/svg?seed=Emma"},{id:"user_55555",name:"Frank Miller",imageUrl:"https://api.dicebear.com/7.x/avataaars/svg?seed=Frank"}];class p{constructor(){a(this,"userState",{...l,roles:[...l.roles]})}async getUserInfo(){return await this.delay(100),{data:{...this.userState},success:!0}}async getCommunityInfo(){return await this.delay(150),{data:{...u},success:!0}}async getUserFriends(e=10,t=0){await this.delay(200);const n=Math.max(0,t),i=Math.min(d.length,n+e);return{data:{friends:d.slice(n,i)},success:!0}}async giveRole(e,t){var i;await this.delay(300);const n=u.roles.find(r=>r.id===e);return n?((i=n.assignmentRules)==null?void 0:i.type)==="restricted"?{data:void 0,success:!1,error:`Role ${e} requires special permissions to assign`}:n.assignmentRules===null?{data:void 0,success:!1,error:`Role ${e} cannot be assigned through this interface`}:((t===this.userState.id||t===l.id)&&(this.userState.roles.includes(e)?console.log(`[MockDataProvider] User ${t} already has role ${e}`):(this.userState.roles.push(e),console.log(`[MockDataProvider] Assigned role ${e} to user ${t}`))),{data:void 0,success:!0}):{data:void 0,success:!1,error:`Role ${e} not found`}}async removeRole(e,t){if(await this.delay(250),t===this.userState.id||t===l.id){const n=this.userState.roles.indexOf(e);n>-1&&(this.userState.roles.splice(n,1),console.log(`[MockDataProvider] Removed role ${e} from user ${t}`))}return{data:void 0,success:!0}}resetUserState(){this.userState={...l,roles:[...l.roles]},console.log("[MockDataProvider] User state reset to original")}getCurrentUserState(){return{...this.userState}}addFriend(e){d.push(e),console.log(`[MockDataProvider] Added friend: ${e.name}`)}async delay(e){return new Promise(t=>setTimeout(t,e))}generateRandomUser(){const e=["Alex","Jordan","Taylor","Casey","Morgan","Riley","Sage","Quinn"],t=e[Math.floor(Math.random()*e.length)];return{id:`user_${Date.now()}`,name:`${t} ${Math.floor(Math.random()*1e3)}`,imageUrl:`https://api.dicebear.com/7.x/avataaars/svg?seed=${t}`}}getAssignableRoles(){return u.roles.filter(e=>{var t;return((t=e.assignmentRules)==null?void 0:t.type)==="free"||e.assignmentRules===null})}canAssignRole(e,t){var i,r;const n=u.roles.find(s=>s.id===e);return n?((i=n.assignmentRules)==null?void 0:i.type)==="free"?!0:(n.assignmentRules===null||((r=n.assignmentRules)==null?void 0:r.type)==="restricted",!1):!1}}class f{constructor(){a(this,"pluginHost");a(this,"mockDataProvider");a(this,"currentPluginUrl",null);this.mockDataProvider=new p,this.pluginHost=new h(this.mockDataProvider),this.setupEventListeners(),this.log("Host application initialized","info")}setupEventListeners(){const e=document.getElementById("plugin-url"),t=document.getElementById("custom-url-group");e.addEventListener("change",()=>{e.value==="custom"?t.classList.remove("hidden"):t.classList.add("hidden")}),document.getElementById("load-plugin").addEventListener("click",()=>{this.handleLoadPlugin()}),document.getElementById("unload-plugin").addEventListener("click",()=>{this.handleUnloadPlugin()}),this.pluginHost.on("plugin-loaded",r=>{this.onPluginLoaded(r.iframeUid,r.url)}),this.pluginHost.on("plugin-error",r=>{this.onPluginError(r.error)}),this.pluginHost.on("api-request",r=>{this.onApiRequest(r.method,r.params)}),this.pluginHost.on("plugin-communication",r=>{this.log(`Plugin communication: ${r.type} - ${r.method||"N/A"}`,"info")})}async handleLoadPlugin(){const e=document.getElementById("plugin-url"),t=document.getElementById("custom-url"),n=document.getElementById("plugin-height");let i;if(e.value==="custom"){if(i=t.value.trim(),!i){this.log("Please enter a custom plugin URL","error");return}}else if(e.value)i=e.value;else{this.log("Please select a plugin URL","error");return}const r=parseInt(n.value)||600;try{this.updateStatus("loading","Loading plugin..."),this.log(`Loading plugin from: ${i}`,"info"),this.currentPluginUrl&&await this.pluginHost.unloadPlugin(),await this.pluginHost.loadPlugin({url:i,height:`${r}px`,allowedOrigins:["*"]}),this.currentPluginUrl=i}catch(s){this.log(`Failed to load plugin: ${s instanceof Error?s.message:"Unknown error"}`,"error"),this.updateStatus("error","Failed to load")}}async handleUnloadPlugin(){if(this.currentPluginUrl)try{this.log("Unloading plugin...","info"),await this.pluginHost.unloadPlugin(),this.currentPluginUrl=null,document.getElementById("plugin-section").classList.add("hidden");const t=document.getElementById("load-plugin"),n=document.getElementById("unload-plugin");t.disabled=!1,n.disabled=!0,this.log("Plugin unloaded successfully","success")}catch(e){this.log(`Failed to unload plugin: ${e instanceof Error?e.message:"Unknown error"}`,"error")}}onPluginLoaded(e,t){this.log(`Plugin loaded successfully with UID: ${e}`,"success"),this.updateStatus("connected","Connected"),document.getElementById("plugin-section").classList.remove("hidden");const i=document.getElementById("current-plugin-url");i.textContent=t;const r=document.getElementById("load-plugin"),s=document.getElementById("unload-plugin");r.disabled=!0,s.disabled=!1}onPluginError(e){this.log(`Plugin error: ${e}`,"error"),this.updateStatus("error","Error")}onApiRequest(e,t){this.log(`API Request: ${e}${t?` with params: ${JSON.stringify(t)}`:""}`,"info")}updateStatus(e,t){const n=document.getElementById("plugin-status");n.className=`status ${e}`,n.textContent=t}log(e,t="info"){const n=document.getElementById("log-container"),i=document.createElement("div");i.className=`log-entry log-${t}`;const r=new Date().toLocaleTimeString();i.textContent=`[${r}] ${e}`,n.appendChild(i);const s=n.parentElement;for(s.scrollTop=s.scrollHeight;n.children.length>100;)n.removeChild(n.firstChild);console.log(`[HostApp] ${e}`)}}document.addEventListener("DOMContentLoaded",()=>{new f});
