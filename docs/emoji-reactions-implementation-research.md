# Emoji Reactions Implementation Research

**Created:** 2025-01-21  
**Updated:** 2025-01-21 (Refined with library research & Discord patterns)
**Status:** Ready for Implementation  
**Priority:** High - Better User Engagement Than Polls  

## Executive Summary

This document outlines the implementation of a **comprehensive emoji reactions system** for Curia2 posts and comments, designed to operate alongside the existing voting system. Based on research and your design decisions, we'll use **emoji-mart** library with Discord-style UI patterns to create an intuitive, expressive engagement system.

## Design Decisions ‚úÖ

Based on your requirements:

1. **Dual System**: Reactions operate alongside votes (votes stay, reactions below content)
2. **Emoji Library**: emoji-mart for wide choice + default palette
3. **Gating**: Board-level gating like votes (not strict like comments)
4. **Future-Proof Database**: Designed for both posts AND comments from start
5. **UI Placement**: Bottom of content area, visible when posts collapsed (Discord-style)

## Library Research Results

### **Recommended: emoji-mart** üèÜ

**Why emoji-mart wins:**
- **Most Popular**: 9.1k stars, 687k weekly downloads, 56k+ users
- **React-Ready**: Built-in TypeScript support, React package available
- **Modular Data**: Can bundle emoji data or fetch remotely (bundle size control)
- **Rich Features**: Search, categories, custom emojis, themes, internationalization
- **Stable & Maintained**: Regular updates, comprehensive documentation
- **Performance**: Native emoji set option (most performant)

**Installation:**
```bash
yarn add emoji-mart @emoji-mart/data @emoji-mart/react
```

**Basic Usage:**
```typescript
import data from '@emoji-mart/data'
import Picker from '@emoji-mart/react'

function EmojiPickerComponent() {
  return (
    <Picker 
      data={data} 
      onEmojiSelect={(emoji) => handleReaction(emoji.native)}
      theme="auto"
      previewPosition="none"
      skinTonePosition="none"
    />
  )
}
```

## Discord UI Pattern Analysis

### **Reaction Pills Design**
- **Visual**: `üòÇ 5` style pills with emoji + count
- **Interaction**: Click to add/remove your reaction
- **Multi-User**: Multiple users can react with same emoji
- **Hover Tooltips**: "You, Alice, Bob and 2 others reacted with üòÇ"
- **User Indication**: Highlight pills when user has reacted

### **Layout Pattern**
- **Position**: Below message content, before any other UI elements
- **Responsive**: Wraps to multiple lines on small screens
- **Add Button**: `üòä+` or `‚ûï` button to open emoji picker
- **Collapsed State**: Visible even when post cards are collapsed

## Updated Architecture

### **Database Schema** (Future-Proof)
```sql
-- New reactions table (independent from votes)
CREATE TABLE "public"."reactions" (
    "id" integer DEFAULT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    "user_id" text NOT NULL,
    "post_id" integer,
    "comment_id" integer,
    "emoji" varchar(10) NOT NULL, -- Unicode emoji (üëç, ‚ù§Ô∏è, üòÇ, etc.)
    "created_at" timestamptz DEFAULT CURRENT_TIMESTAMP NOT NULL,
    "updated_at" timestamptz DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT "reactions_pkey" PRIMARY KEY ("id"),
    CONSTRAINT "reactions_content_check" CHECK (
        (post_id IS NOT NULL AND comment_id IS NULL) OR 
        (post_id IS NULL AND comment_id IS NOT NULL)
    )
);

-- One instance of each emoji per user per content
CREATE UNIQUE INDEX reactions_user_post_emoji_key 
ON public.reactions (user_id, post_id, emoji) 
WHERE post_id IS NOT NULL;

CREATE UNIQUE INDEX reactions_user_comment_emoji_key 
ON public.reactions (user_id, comment_id, emoji) 
WHERE comment_id IS NOT NULL;

-- Performance indexes
CREATE INDEX reactions_post_id_index ON public.reactions (post_id);
CREATE INDEX reactions_comment_id_index ON public.reactions (comment_id);
CREATE INDEX reactions_emoji_index ON public.reactions (emoji);

-- Foreign key constraints
ALTER TABLE reactions ADD CONSTRAINT reactions_user_id_fkey 
FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE;

ALTER TABLE reactions ADD CONSTRAINT reactions_post_id_fkey 
FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE;

ALTER TABLE reactions ADD CONSTRAINT reactions_comment_id_fkey 
FOREIGN KEY (comment_id) REFERENCES comments(id) ON DELETE CASCADE;
```

### **API Design**

#### **POST /api/posts/[postId]/reactions**
```typescript
interface ReactRequest {
  emoji: string; // 'üëç', '‚ù§Ô∏è', etc.
  action: 'add' | 'remove';
}

interface ReactResponse {
  success: boolean;
  reactions: ReactionSummary[];
  userReactions: string[];
}
```

#### **GET /api/posts/[postId]/reactions**
```typescript
interface ReactionsResponse {
  reactions: ReactionSummary[];
  userReactions: string[]; // Emojis current user has reacted with
  totalCount: number;
}

interface ReactionSummary {
  emoji: string;
  count: number;
  users: Array<{ userId: string; name: string; avatar?: string }>;
}
```

### **React Components Architecture**

#### **ReactionBar Component**
```typescript
interface ReactionBarProps {
  postId?: number;
  commentId?: number;
  reactions: ReactionSummary[];
  userReactions: string[];
  onReact: (emoji: string) => void;
  onUnreact: (emoji: string) => void;
  canReact: boolean; // Based on board gating permissions
  showAddButton?: boolean; // Show emoji picker trigger
}
```

#### **Component Hierarchy**
```
PostCard / CommentItem
‚îú‚îÄ‚îÄ VoteButton (existing, left sidebar)
‚îî‚îÄ‚îÄ ContentArea
    ‚îú‚îÄ‚îÄ PostContent
    ‚îî‚îÄ‚îÄ ReactionBar (new, bottom of content)
        ‚îú‚îÄ‚îÄ ReactionPill[] (existing reactions)
        ‚îî‚îÄ‚îÄ AddReactionButton (emoji picker trigger)
```

## Implementation Roadmap

### **Phase 1: Core System** (Week 1)

**Day 1-2: Database & Migration**
- [x] Create reactions table migration
- [x] Add foreign key constraints and indexes
- [x] Update TypeScript interfaces

**Day 3-4: API Endpoints**
- [x] POST /api/posts/[postId]/reactions (add/remove)
- [x] GET /api/posts/[postId]/reactions (fetch summaries)
- [x] Apply board-level gating (copy from votes pattern)
- [x] Add rate limiting (10 reactions/minute per user)

**Day 5-7: React Components**
- [x] Install emoji-mart library
- [x] Create ReactionBar component
- [x] Create ReactionPill component
- [x] Create EmojiPickerModal component
- [x] Integrate into PostCard component

### **Phase 2: Polish & Real-time** (Week 2)

**Day 1-3: Real-time Integration**
- [x] Add `reactionUpdate` event to Socket.IO system
- [x] Update SocketContext to handle reaction events
- [x] Real-time reaction count updates
- [x] Optimistic UI updates

**Day 4-5: UI/UX Polish**
- [x] Discord-style reaction pills design
- [x] Hover tooltips showing user names
- [x] Smooth animations for add/remove
- [x] Mobile-responsive design

**Day 6-7: Testing & Edge Cases**
- [x] Rate limiting enforcement
- [x] Permission edge cases
- [x] Network error handling
- [x] User feedback (toasts, loading states)

### **Phase 3: Comments Support** (Week 3)

**Day 1-3: Comment API Endpoints**
- [x] POST /api/comments/[commentId]/reactions
- [x] GET /api/comments/[commentId]/reactions
- [x] Update ReactionBar to support both posts and comments

**Day 4-5: Comment UI Integration**
- [x] Add ReactionBar to CommentItem component
- [x] Ensure proper spacing and layout
- [x] Real-time events for comment reactions

**Day 6-7: System Integration**
- [x] End-to-end testing
- [x] Performance optimization
- [x] Documentation updates

## Security & Performance

### **Gating Integration**
```typescript
// Copy exact pattern from votes/route.ts
const boardLockGating = SettingsUtils.getBoardLockGating(boardSettings);

if (boardLockGating && boardLockGating.lockIds.length > 0) {
  // Check user's verification status for required locks
  // Apply fulfillment logic (ANY vs ALL)
  // Block if requirements not met
}
```

### **Rate Limiting**
```typescript
// Redis-based rate limiting
const userKey = `reactions:${userId}`;
const current = await redis.incr(userKey);
if (current === 1) await redis.expire(userKey, 60); // 1 minute window
if (current > 10) throw new Error('Rate limit exceeded');
```

### **Performance Optimizations**
- **Caching**: Redis cache for popular posts' reaction summaries
- **Pagination**: Limit user lists in reaction tooltips to prevent large payloads
- **Debouncing**: Prevent rapid-fire reaction spam
- **Indexing**: Proper database indexes for emoji and content queries

## Real-time Integration

### **Socket.IO Events**
```typescript
// Extend existing Socket.IO system
interface ReactionUpdateEvent {
  type: 'reaction_update';
  postId?: number;
  commentId?: number;
  reactions: ReactionSummary[];
  userId: string; // Who reacted
  emoji: string;
  action: 'add' | 'remove';
}
```

### **React Query Integration**
```typescript
// Similar to vote updates, but for reactions
socket.on('reactionUpdate', (data: ReactionUpdateEvent) => {
  queryClient.setQueryData(['reactions', data.postId || data.commentId], data.reactions);
  
  // Show toast notification for other users
  if (data.userId !== currentUserId) {
    toast.success(`${userName} reacted with ${data.emoji}`);
  }
});
```

## Success Metrics

### **Engagement Metrics**
- **Reaction Rate**: % of posts/comments that receive reactions
- **Reaction Diversity**: Distribution across different emojis  
- **User Participation**: % of users who react vs just read
- **Emoji Popularity**: Most used emojis in community

### **Technical Metrics**
- **Response Time**: API endpoint performance
- **Real-time Latency**: Socket.IO event delivery speed
- **Cache Hit Rate**: Redis reaction summary cache effectiveness
- **Error Rate**: Failed reaction attempts

## Next Steps Summary

### **Immediate Actions** (This Session)
1. **Create Migration**: Database schema for reactions table
2. **Install emoji-mart**: Add library dependencies
3. **Basic API Endpoint**: POST /api/posts/[postId]/reactions
4. **Proof of Concept**: Simple ReactionBar component

### **This Week Priority**
1. **Complete Phase 1**: Core system with database, API, and basic UI
2. **Test Integration**: Ensure gating works with existing board system
3. **User Feedback**: Get initial reactions from community
4. **Performance Baseline**: Measure current system before optimization

---

## Implementation Notes

### **Library Configuration**
```typescript
// Recommended emoji-mart config for Discord-style experience
const emojiPickerConfig = {
  data: emojiData,
  theme: 'auto',
  previewPosition: 'none', // Discord doesn't show preview
  skinTonePosition: 'none', // Simplify for MVP
  searchPosition: 'sticky',
  maxFrequentRows: 2, // Recent emojis
  categories: ['frequent', 'people', 'nature', 'foods', 'activity'], // Curated set
  perLine: 8, // Mobile-friendly
  emojiSize: 24,
  emojiButtonSize: 32
};
```

### **Gating Pattern Reuse**
Your existing vote gating is perfect! We'll copy the exact same pattern:
```typescript
// From your votes/route.ts - this is exactly what we need
const boardLockGating = SettingsUtils.getBoardLockGating(boardSettings);
if (boardLockGating && boardLockGating.lockIds.length > 0) {
  // Check verification status, apply fulfillment logic
  // Block if requirements not met
}
```

### **Dual System Benefits**
- **Votes**: Quick binary feedback (like/don't like)
- **Reactions**: Nuanced emotional responses (funny, love, celebrate)
- **No Migration**: Both systems operate independently
- **User Choice**: Some prefer voting, others prefer reactions

---

**Recommendation**: Start with Phase 1 this session to get core functionality working, then iterate based on community feedback. The foundation you have makes this implementation straightforward and low-risk.